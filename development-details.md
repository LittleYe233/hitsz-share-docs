# Hikaru Share Documentation - Development Details

## 简介

本文件系 "Hikaru Share" 项目开发过程中的部分细节.

## 人员

### 服务提供方

本项目的相关服务的提供方和维护方为本项目的全体成员. 如若本项目能继续运作, 将考虑招募其他人员.

### 服务使用方

本项目的相关服务的使用方暂定为特定类别学籍号人员. 如若本项目能继续运作, 将考虑纳入其他接入 CERNET 的人员.

### 信任等级

此小节主要描述的是授权用户的分类机制. 考虑到此机制主要以等级的方式呈现, 且可以用于评定服务提供方对授权用户的信任程度, 特以 "信任等级" 指代. 本小节后续内容中与[项目服务](/goals.md#服务)和[网站中的论坛](/goals.md#网站和数据库)相关的信任等级均以 "信任等级" 作为统称.

信任等级不是一成不变的, 且依赖于一系列评价标准所计算出的 "**绝对**结果" (信任等级不随其他用户的变动而发生变化) . 项目会根据授权用户的各种相关数据进行综合评定, 以此作为授权用户信任等级升降的依据. 总体上, 若授权用户对项目做出贡献, 项目会更倾向于作出提升信任等级的评定; 反之, 项目则会更倾向于作出降低信任等级的评定; 原则上, 若授权用户保持静默, 项目不会对其信任等级做出改变.

以下是项目服务和网站论坛的信任等级评定时的主要判据:

| 项目 | 判据 |
| :-: | :-: |
| 项目服务 | 共享率<sup>\[1\]</sup>, 上行量<sup>\[2\]</sup>, 上行限额<sup>\[3\]</sup>, 种子发布量, 种子质量, 上行时长<sup>\[4\]</sup>等 |
| 网站论坛<sup>\[5\]</sup> | 项目服务的信任等级, 活跃度, 发言质量等 |

其中:

1. 共享率: 上行量与下行量的比值, 类似概念为 "共享限额比值" (上行限额与下行限额的比值);
2. 上行量: 根据授权用户本地可供共享的部分 (从 "共享资源" 与 "共享网盘" 的上传量以及 "共享算力" 的被消耗算力中抽象出的概念) 计算出的量, 相对概念为 "下行量" , 类似概念为 "上行限额";
3. 上行限额: 授权用户设置的一定范围内 (一般为时间范围) 上行量的最大值;
4. 上行时长: 授权用户进行有效共享行为时的时长;
5. 网站论坛信任等级的判据或完全由服务提供方指定, 或部分交由论坛模板的开发者指定, 具体由网站论坛的实现方式而定.

有关上述 "绝对结果" 的具体实现方式和其与信任等级的关联, 主要有如下两种选择:

- 指标式: 每个信任等级具有一定的指标, 分别用于提升至更高的等级和下降至更低的等级, 这些指标直接由相应的判据控制 (例如限定超过某一共享率可以使授权用户获得更高的信任等级);
- 经验式: 参考 RPG (角色扮演游戏) 中的等级系统, 将指标式中的指标改为 "经验值" , 授权用户的一切与判据相关的行为都会直接改变其经验值, 而经验值的高低则会对信任等级的升降造成影响.

一般来说, 指标式可以使授权用户直观地得出不同信任等级所需的指标, 且无需另行设计额外的转化算法; 经验式可以将判据进一步量化, 便于数据的管理, 减少代码的耦合度.

## 共享资源 (shared resource)

### Tracker

Tracker 本质上是一种可以接受 HTTP GET 请求的 HTTP/HTTPS 服务. BitTorrent 客户端需要定期向 Tracker 发送 HTTP GET 请求, 其中包含对于该种子的详细信息以及客户端的相关统计数据, Tracker 在接收请求后, 通过一系列操作 (例如数据库操作) 向客户端返回一个应答 (response) , 其中包含该种子对应的节点 (peers) 列表.

有关 Tracker 的请求和应答的格式, 请参阅知识库[相关章节](/knowledge-base/tracker/http-service.md).

### 数据库

Tracker 的数据库需要存储种子和节点的相关信息. 考虑到项目的需求和数据库软件的开源性, 小组使用关系型数据库 MariaDB (MySQL 的一个开源分支) 存储数据.

为避免权限泄露, 小组在服务器上新建一个用户专用于操作相关的数据库, 且限制其更改数据库结构的权限. 小组设计本服务的 Tracker 所需的数据库及其数据表的内部结构如下:

- Tracker 数据库
  - 种子数据表
    - `info_hash` 列: 种子的 `info_hash`. **主键**, **分区**, `CHAR(20)`.
    - `seeders` 列: 种子的所有 seeder 在节点数据表中的 ID 的列表: `JSON ARRAY`.
    - `leechers` 列: 种子的所有 leecher 在节点数据表中的 ID 的列表: `JSON ARRAY`.
  - 节点数据表
    - `id` 列: 节点由数据库软件分配的 ID. **主键**, **自增**, `MEDIUMINT UNSIGNED`.
    - `peer_id` 列: 参见 [Tracker HTTP GET 请求的参数](/knowledge-base/tracker/http-service.md#参数). `CHAR(20)`.
    - `ip`: 参见 [Tracker HTTP GET 请求的参数](/knowledge-base/tracker/http-service.md#参数). `VARCHAR(64)` **(暂定长度为 64)**.
    - `port`: 参见 [Tracker HTTP GET 请求的参数](/knowledge-base/tracker/http-service.md#参数). `SMALLINT UNSIGNED`.

同时, Tracker 还需要访问授权用户数据库, 以判断 BitTorrent 客户端发送的请求带有的 `passkey` 键值是否属于某一授权用户. Tracker 需要向该数据库所在服务器发送请求, 根据应答得到结果.